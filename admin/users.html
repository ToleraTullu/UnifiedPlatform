<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>UniManage - User Management</title>
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar"></aside>
    <main class="main-content">
      <header class="topbar"></header>
      <div class="content-wrapper">
        <div class="card">
          <h3>User Management</h3>
          <p style="color:#64748b">Create users and assign them to a sector or make them admins.</p>
          <div id="no-access" style="display:none;color:#ef4444;font-weight:bold">Access denied. Admins only.</div>

          <form id="user-form" style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;margin-top:10px;">
            <div class="form-group">
              <label>Username</label>
              <input name="username" required />
            </div>
            <div class="form-group">
              <label>Password</label>
              <input name="password" type="password" required />
            </div>
            <div class="form-group">
              <label>Full Name</label>
              <input name="name" />
            </div>
            <div class="form-group">
              <label>Role / Sector</label>
              <select name="role">
                <option value="pharmacy_user">Pharmacy</option>
                <option value="exchange_user">Exchange</option>
                <option value="construction_user">Construction</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="form-group">
              <button class="btn-primary" type="submit">Create</button>
            </div>
          </form>

          <div style="margin-top:1rem">
            <table class="data-table">
              <thead><tr><th>Username</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead>
              <tbody id="users-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../assets/js/store.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/layout.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const user = window.Auth && window.Auth.currentUser;
      if (!user || user.role !== 'admin') {
        document.getElementById('no-access').style.display = 'block';
        document.getElementById('user-form').style.display = 'none';
        return;
      }

      const tbody = document.getElementById('users-body');
      const form = document.getElementById('user-form');

      function render() {
        const users = window.Store.get('unified_users') || [];
        tbody.innerHTML = '';
        users.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.username}</td><td>${u.name||''}</td><td>${u.role}</td><td><button class="btn-secondary edit-user" data-user="${u.username}">Edit</button> <button class="btn-danger delete-user" data-user="${u.username}">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      }

      render();

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const userObj = { username: fd.get('username').trim(), password: fd.get('password'), name: fd.get('name')||'', role: fd.get('role') };
        if (!userObj.username || !userObj.password) { alert('username and password required'); return; }
        const users = window.Store.get('unified_users') || [];
        if (users.some(u => u.username === userObj.username)) { alert('username exists'); return; }
        users.push(userObj);
        window.Store.set('unified_users', users);
        form.reset(); render();
      });

      tbody.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button'); if (!btn) return;
        const uname = btn.dataset.user;
        if (btn.classList.contains('delete-user')) {
          if (!confirm('Delete user '+uname+'?')) return;
          let users = window.Store.get('unified_users') || [];
          users = users.filter(u => u.username !== uname);
          window.Store.set('unified_users', users); render();
        } else if (btn.classList.contains('edit-user')) {
          const users = window.Store.get('unified_users') || [];
          const u = users.find(x => x.username === uname);
          if (!u) return; 
          const newName = prompt('Full name', u.name||''); if (newName===null) return;
          const newRole = prompt('Role (admin,exchange_user,pharmacy_user,construction_user)', u.role) || u.role;
          u.name = newName; u.role = newRole;
          window.Store.set('unified_users', users); render();
        }
      });
    });
  </script>
</body>
</html>
